<main class="app-container" [class.drag-over]="isDragOver">
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="logo-text">Kafka Publisher</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" (click)="showCreateTopic = !showCreateTopic; showConsumer = false" [class.btn-active]="showCreateTopic">
        <svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Topic
      </button>
      <button class="btn btn-sm" (click)="showConsumer = !showConsumer; showCreateTopic = false" [class.btn-active]="showConsumer">
        <svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
        </svg>
        View
      </button>
      <button class="btn btn-sm" (click)="showSettings = !showSettings">
        <svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
          <path d="M19.4 15C19.2 15.3 19.1 15.7 19.2 16L19.9 17.2C20.1 17.5 20 17.9 19.7 18.1L18.1 19.7C17.9 19.9 17.5 20 17.2 19.8L16 19.1C15.7 19 15.3 19 15 19.2L14.8 19.2C14.5 19.3 14.2 19.6 14.1 19.9L13.8 21.2C13.7 21.6 13.4 21.9 13 21.9H10.9C10.5 21.9 10.2 21.6 10.1 21.2L9.8 19.9C9.7 19.6 9.4 19.3 9.1 19.2L8.9 19.2C8.6 19.1 8.2 19.1 7.9 19.2L6.7 19.9C6.4 20.1 6 20 5.8 19.7L4.2 18.1C4 17.9 3.9 17.5 4.1 17.2L4.8 16C4.9 15.7 4.9 15.3 4.7 15L4.6 14.8C4.5 14.5 4.2 14.2 3.9 14.1L2.7 13.8C2.3 13.7 2 13.4 2 13V10.9C2 10.5 2.3 10.2 2.7 10.1L3.9 9.8C4.2 9.7 4.5 9.4 4.6 9.1L4.7 8.9C4.8 8.6 4.8 8.2 4.7 7.9L4 6.7C3.8 6.4 3.9 6 4.2 5.8L5.8 4.2C6 4 6.4 3.9 6.7 4.1L7.9 4.8C8.2 4.9 8.6 4.9 8.9 4.7L9.1 4.6C9.4 4.5 9.7 4.2 9.8 3.9L10.1 2.7C10.2 2.3 10.5 2 10.9 2H13C13.4 2 13.7 2.3 13.8 2.7L14.1 3.9C14.2 4.2 14.5 4.5 14.8 4.6L15 4.7C15.3 4.8 15.7 4.8 16 4.7L17.2 4C17.5 3.8 17.9 3.9 18.1 4.2L19.7 5.8C19.9 6 20 6.4 19.8 6.7L19.1 7.9C19 8.2 19 8.6 19.2 8.9L19.2 9.1C19.3 9.4 19.6 9.7 19.9 9.8L21.2 10.1C21.6 10.2 21.9 10.5 21.9 10.9V13C21.9 13.4 21.6 13.7 21.2 13.8L19.9 14.1C19.6 14.2 19.3 14.5 19.2 14.8L19.4 15Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        Settings
      </button>
    </div>
  </header>

  <!-- Settings Panel -->
  @if (showSettings) {
    <div class="settings-panel card animate-fade-in">
      <div class="settings-header">
        <h2>Configuration</h2>
        <button class="theme-toggle-btn" (click)="toggleTheme()" title="Toggle theme">
          @if (isDarkMode) {
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
              <path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          } @else {
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          }
        </button>
      </div>
      <div class="settings-grid">
        <div class="form-group">
          <label for="broker">Broker Address</label>
          <input id="broker" class="input" [(ngModel)]="config.broker" placeholder="localhost:9092" />
        </div>
        <div class="form-group">
          <label for="topic">Topic</label>
          <input id="topic" class="input" [(ngModel)]="config.topic" placeholder="my-topic" />
        </div>
        <div class="form-group">
          <label for="clientId">Client ID</label>
          <input id="clientId" class="input" [(ngModel)]="config.client_id" placeholder="kafka-msg-publisher" />
        </div>
      </div>
      <!-- Security Settings -->
      <div class="security-section">
        <div class="security-header" (click)="showSecuritySettings = !showSecuritySettings">
          <h3>Security</h3>
          <svg class="icon chevron" [class.rotated]="showSecuritySettings" viewBox="0 0 24 24" fill="none">
            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        @if (showSecuritySettings) {
          <div class="security-content animate-fade-in">
            <div class="form-group">
              <label for="securityProtocol">Security Protocol</label>
              <select id="securityProtocol" class="input" [(ngModel)]="config.security_protocol">
                <option value="Plaintext">PLAINTEXT</option>
                <option value="Ssl">SSL</option>
                <option value="SaslPlaintext">SASL_PLAINTEXT</option>
                <option value="SaslSsl">SASL_SSL</option>
              </select>
            </div>

            @if (config.security_protocol === 'SaslPlaintext' || config.security_protocol === 'SaslSsl') {
              <div class="settings-grid">
                <div class="form-group">
                  <label for="saslUsername">SASL Username</label>
                  <input id="saslUsername" class="input" [(ngModel)]="config.sasl_username" placeholder="username" />
                </div>
                <div class="form-group">
                  <label for="saslPassword">SASL Password</label>
                  <input id="saslPassword" class="input" type="password" [(ngModel)]="config.sasl_password" placeholder="password" />
                </div>
              </div>
            }

            @if (config.security_protocol === 'Ssl' || config.security_protocol === 'SaslSsl') {
              <div class="ssl-settings">
                <div class="form-group">
                  <label for="caCert">CA Certificate (PEM)</label>
                  <div class="file-input-group">
                    <input id="caCert" class="input" [(ngModel)]="config.ssl_ca_cert_path" placeholder="Path to CA certificate (optional, uses system certs if empty)" />
                    <button class="btn btn-sm" (click)="browseCertFile('ssl_ca_cert_path')">Browse</button>
                  </div>
                </div>
                <div class="form-group">
                  <label for="clientCert">Client Certificate (PEM) — for mTLS</label>
                  <div class="file-input-group">
                    <input id="clientCert" class="input" [(ngModel)]="config.ssl_client_cert_path" placeholder="Path to client certificate (optional)" />
                    <button class="btn btn-sm" (click)="browseCertFile('ssl_client_cert_path')">Browse</button>
                  </div>
                </div>
                <div class="form-group">
                  <label for="clientKey">Client Key (PEM) — for mTLS</label>
                  <div class="file-input-group">
                    <input id="clientKey" class="input" [(ngModel)]="config.ssl_client_key_path" placeholder="Path to client private key (optional)" />
                    <button class="btn btn-sm" (click)="browseCertFile('ssl_client_key_path')">Browse</button>
                  </div>
                </div>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" [(ngModel)]="config.ssl_skip_verification" />
                    <span>Skip certificate verification (insecure, for testing only)</span>
                  </label>
                </div>
              </div>
            }
          </div>
        }
      </div>
      <div class="settings-actions">
        @if (isTesting) {
          <button class="btn btn-danger" (click)="cancelTestConnection()">
            Cancel
          </button>
        } @else {
          <button class="btn" (click)="testConnection()" [disabled]="isLoading">
            Test Connection
          </button>
        }
        @if (isLoading) {
          <span class="testing-indicator">
            <span class="spinner"></span>
          </span>
        }
        @if (!isLoading && connectionStatus === 'connected') {
          <span class="badge badge-success">Connected</span>
        } @else if (!isLoading && connectionStatus === 'error') {
          <span class="badge badge-error">Failed</span>
        }
        <button class="btn btn-primary" (click)="saveConfig()" [disabled]="isTesting">Save</button>
      </div>
    </div>
  }

  <!-- Main Content -->
  <div class="main-content">
    <!-- Create Topic Panel -->
    @if (showCreateTopic) {
      <section class="create-topic-panel card animate-fade-in">
        <h2>Create Topic</h2>
        <div class="settings-grid">
          <div class="form-group">
            <label for="newTopicName">Topic Name</label>
            <input id="newTopicName" class="input" [(ngModel)]="newTopicName" placeholder="my-new-topic" />
          </div>
          <div class="form-group">
            <label for="numPartitions">Partitions</label>
            <input id="numPartitions" class="input" type="number" [(ngModel)]="newTopicPartitions" min="1" max="100" />
          </div>
          <div class="form-group">
            <label for="replicationFactor">Replication Factor</label>
            <input id="replicationFactor" class="input" type="number" [(ngModel)]="newTopicReplication" min="1" max="10" />
          </div>
        </div>
        <div class="create-topic-actions">
          <button
            class="btn btn-primary"
            (click)="createTopic()"
            [disabled]="!newTopicName.trim() || isCreatingTopic"
          >
            @if (isCreatingTopic) {
              <span class="spinner"></span>
              Creating...
            } @else {
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Create Topic
            }
          </button>
          @if (topicCreateStatus === 'success') {
            <span class="badge badge-success">{{ topicCreateMessage }}</span>
          } @else if (topicCreateStatus === 'error') {
            <span class="badge badge-error topic-error-badge">{{ topicCreateMessage }}</span>
          }
        </div>
      </section>
    }

    <!-- Message Consumer / Viewer Panel -->
    @if (showConsumer) {
      <section class="consumer-panel card animate-fade-in">
        <h2>Message Viewer</h2>
        <div class="consumer-controls">
          <div class="form-group">
            <label for="consumeTopic">Topic</label>
            <input id="consumeTopic" class="input" [(ngModel)]="consumeTopic" [placeholder]="config.topic" />
          </div>
          <div class="form-group">
            <label for="consumeOffset">Start Offset</label>
            <input id="consumeOffset" class="input" type="number" [(ngModel)]="consumeOffset" min="0" />
          </div>
          <div class="form-group">
            <label for="consumeMax">Max Messages</label>
            <input id="consumeMax" class="input" type="number" [(ngModel)]="consumeMaxMessages" min="1" max="500" />
          </div>
          <div class="form-group form-group-btn">
            <button
              class="btn btn-primary"
              (click)="fetchMessages()"
              [disabled]="isConsuming"
            >
              @if (isConsuming) {
                <span class="spinner"></span>
                Fetching...
              } @else {
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M23 4V10H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M20.49 15A9 9 0 1 1 21 5.64L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Fetch
              }
            </button>
          </div>
        </div>

        @if (consumeError) {
          <p class="consume-error">{{ consumeError }}</p>
        }

        @if (consumedMessages.length > 0) {
          <div class="consumed-messages-list">
            <div class="consumed-messages-header">
              <span class="col-offset">Offset</span>
              <span class="col-key">Key</span>
              <span class="col-value">Value</span>
              <span class="col-time">Timestamp</span>
            </div>
            @for (msg of consumedMessages; track msg.offset) {
              <div class="consumed-message-row" (click)="openMessageDetail(msg)">
                <span class="col-offset text-mono">{{ msg.offset }}</span>
                <span class="col-key text-mono">{{ msg.key ?? '—' }}</span>
                <span class="col-value text-mono">{{ msg.value ? truncateMessage(msg.value, 80) : '—' }}</span>
                <span class="col-time text-muted">{{ formatMessageTimestamp(msg.timestamp) }}</span>
              </div>
            }
          </div>
          <p class="consume-summary text-muted">{{ consumedMessages.length }} message(s) fetched</p>
        }
      </section>
    }

    <!-- Config Display -->
    <section class="config-bar card">
      <div class="config-item">
        <span class="config-label">Server</span>
        <span class="config-value text-mono">{{ config.broker }}</span>
      </div>
      <div class="config-divider"></div>
      <div class="config-item">
        <span class="config-label">Topic</span>
        <span class="config-value text-mono">{{ config.topic }}</span>
      </div>
      @if (config.security_protocol !== 'Plaintext') {
        <div class="config-divider"></div>
        <div class="config-item">
          <span class="config-label">Security</span>
          <span class="config-value text-mono security-badge">{{ getSecurityLabel() }}</span>
        </div>
      }
      <div class="config-spacer"></div>
      <!-- Connection Status Indicator -->
      <div class="connection-status" [title]="connectionStatus === 'connected' ? 'Connected' : connectionStatus === 'error' ? 'Disconnected' : connectionStatus === 'testing' ? 'Testing...' : 'Unknown'">
        @if (connectionStatus === 'connected') {
          <svg class="status-icon status-connected" viewBox="0 0 24 24" fill="none">
            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        } @else if (connectionStatus === 'error') {
          <svg class="status-icon status-error" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        } @else if (connectionStatus === 'testing') {
          <span class="spinner status-testing"></span>
        } @else {
          <svg class="status-icon status-unknown" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M9 9C9 7.5 10.5 6.5 12 6.5C13.5 6.5 15 7.5 15 9C15 10.5 13.5 11 12 12V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="17" r="1" fill="currentColor"/>
          </svg>
        }
      </div>
    </section>

    <!-- Message Input -->
    <section class="message-section card">
      <div class="message-header">
        <h2>Message</h2>
        <span class="char-count text-muted">{{ messageContent.length }} characters</span>
      </div>
      <textarea 
        class="textarea message-input"
        [(ngModel)]="messageContent"
        placeholder="Enter your message here or drop a file..."
        [class.drag-highlight]="isDragOver"
      ></textarea>
      <div class="message-actions">
        <div class="message-actions-left">
          <button class="attach-btn" (click)="attachFile()" title="Attach file">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M21.44 11.05L12.25 20.24C11.12 21.37 9.58 22 7.97 22C6.36 22 4.82 21.37 3.69 20.24C2.56 19.11 1.93 17.57 1.93 15.96C1.93 14.35 2.56 12.81 3.69 11.68L12.88 2.49C13.63 1.74 14.64 1.32 15.7 1.32C16.76 1.32 17.77 1.74 18.52 2.49C19.27 3.24 19.69 4.25 19.69 5.31C19.69 6.37 19.27 7.38 18.52 8.13L9.32 17.32C8.95 17.69 8.44 17.90 7.91 17.90C7.38 17.90 6.87 17.69 6.50 17.32C6.13 16.95 5.92 16.44 5.92 15.91C5.92 15.38 6.13 14.87 6.50 14.50L15.70 5.31" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Attach
          </button>
          <span class="drop-hint text-muted">or drop a file</span>
        </div>
        <button 
          class="btn btn-primary send-btn" 
          (click)="sendMessage()" 
          [disabled]="!messageContent.trim() || isSending"
        >
          @if (isSending) {
            <span class="spinner"></span>
            Sending...
          } @else {
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Send Message
          }
        </button>
      </div>
    </section>

    <!-- Message History -->
    <section class="history-section card">
      <div class="history-header">
        <h2>History</h2>
        @if (messages.length > 0) {
          <button class="icon-btn" (click)="clearHistory()" title="Clear logs">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 6V4C8 3.44772 8.44772 3 9 3H15C15.5523 3 16 3.44772 16 4V6M19 6V20C19 20.5523 18.5523 21 18 21H6C5.44772 21 5 20.5523 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        }
      </div>
      @if (messages.length === 0) {
        <div class="history-empty">
          <p class="text-muted">No messages sent yet</p>
        </div>
      } @else {
        <div class="history-list">
          @for (msg of messages; track msg.id) {
            <div class="history-item animate-fade-in">
              <div class="history-item-header">
                <span [class]="'badge badge-' + msg.status">{{ msg.status }}</span>
                <span class="history-time text-muted">{{ formatTime(msg.timestamp) }}</span>
              </div>
              <p class="history-content text-mono">{{ truncateMessage(msg.content) }}</p>
              @if (msg.errorMessage) {
                <p class="history-error">{{ msg.errorMessage }}</p>
              }
            </div>
          }
        </div>
      }
    </section>
  </div>

  <!-- Drag Overlay -->
  @if (isDragOver) {
    <div class="drag-overlay">
      <div class="drag-content">
        <svg class="drag-icon" viewBox="0 0 24 24" fill="none">
          <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <p>Drop file to load content</p>
      </div>
    </div>
  }

  <!-- Message Detail Modal -->
  @if (selectedMessage) {
    <div class="modal-overlay" (click)="closeMessageDetail()">
      <div class="modal-content card" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Message Detail</h2>
          <button class="icon-btn" (click)="closeMessageDetail()" title="Close">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="detail-row">
            <span class="detail-label">Offset</span>
            <span class="detail-value text-mono">{{ selectedMessage.offset }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Timestamp</span>
            <span class="detail-value text-mono">{{ formatMessageTimestamp(selectedMessage.timestamp) }}</span>
          </div>
          <div class="detail-row">
            <div class="detail-label-row">
              <span class="detail-label">Key</span>
              @if (selectedMessage.key) {
                <button class="copy-btn" (click)="copyToClipboard(selectedMessage.key, 'key')" title="Copy key">
                  @if (copiedField === 'key') {
                    <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Copied
                  } @else {
                    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path d="M5 15H4C2.89543 15 2 14.1046 2 13V4C2 2.89543 2.89543 2 4 2H13C14.1046 2 15 2.89543 15 4V5" stroke="currentColor" stroke-width="2"/></svg>
                    Copy
                  }
                </button>
              }
            </div>
            <pre class="detail-value-block text-mono">{{ selectedMessage.key ?? '—' }}</pre>
          </div>
          <div class="detail-row">
            <div class="detail-label-row">
              <span class="detail-label">Value</span>
              @if (selectedMessage.value) {
                <button class="copy-btn" (click)="copyToClipboard(selectedMessage.value, 'value')" title="Copy value">
                  @if (copiedField === 'value') {
                    <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Copied
                  } @else {
                    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path d="M5 15H4C2.89543 15 2 14.1046 2 13V4C2 2.89543 2.89543 2 4 2H13C14.1046 2 15 2.89543 15 4V5" stroke="currentColor" stroke-width="2"/></svg>
                    Copy
                  }
                </button>
              }
            </div>
            <pre class="detail-value-block text-mono">{{ selectedMessage.value ?? '—' }}</pre>
          </div>
        </div>
      </div>
    </div>
  }
</main>
